---
title: "Code - CS1"
author: "Will Sherman"
date: "6/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(ggplot2)
require(dplyr)
require(maps)
require(e1071)
require(caret)
require(stringr)
require(gt)
require(tidyr)
```

##Loading data
```{r, warning=F}
beers <- read.csv("~/Grad School - Classes/MSDS - 6306 - Doing Data Science/MSDS_6306_DDS_Git/Unit 8 and 9 Case Study 1/Beers.csv")
breweries <- read.csv("~/Grad School - Classes/MSDS - 6306 - Doing Data Science/MSDS_6306_DDS_Git/Unit 8 and 9 Case Study 1/Breweries.csv")

beers_df <- beers[order(beers$Brewery_id),]
```

#Question 1

##How many breweries are present in each state?
```{r, warning=F}
#initial plot
breweries %>% ggplot(aes(x=State)) +
  geom_histogram(stat="count") +
  labs(title="Count of breweries per state") +
  theme(axis.text.x=element_text(angle=45,hjust=0.8))

#setting up df to append region to breweries
st_reg <- data.frame(State=state.abb, Region=state.region)
st_reg <- rbind(st_reg, data.frame(State="DC", Region="Northeast"))
st_reg$State <- stringr::str_trim(st_reg$State) #trim whitespace
st_reg$Region <- as.character(st_reg$Region)

breweries_df <- breweries[order(breweries$State),]
breweries_df$State <- stringr::str_trim(breweries_df$State) #trim whitespace

#append region to breweries  
breweries_df <- left_join(breweries_df, st_reg)

#plot breweries by state & region
breweries_df %>% ggplot(aes(x=State)) +
  geom_histogram(stat="count") +
  labs(title="Count of breweries per state") +
  theme(axis.text.x=element_text(angle=45,hjust=0.8)) +
  facet_wrap(~Region, scale="free")

b_tabledata <- breweries_df %>%
  group_by(State) %>%
  summarise(Breweries=n()) %>%
  left_join(st_reg)

#re-order data
gt_tbl <- b_tabledata[order(b_tabledata$Breweries, decreasing=T),] %>%
  group_by(Region) %>% gt() %>%
  tab_header("Brewery count by State\nsorted by Region")
  
gt_tbl #couldn't get the table to print "wide"
```
The above graph & table show the number of breweries per state (the histogram is broken down by region). Additional formatting was done outside of R to transform table into "wide" format.

#Question 2

##Merge beer data with the breweries data. Print the first 6 observations and the last 6 observations to check the merged file. (RMD only)
```{r}
combined <- merge(beers_df, breweries_df, by.x="Brewery_id", by.y="Brew_ID")
#head of the merged dataframe
head(combined,6)
#tail of the merged dataframe
tail(combined,6)
```

#Question 3

##Address the missing values in each column.
```{r, warning=F}
sum(is.na(combined)) #number of total NA's
sum(is.na(combined$IBU)) #number of NA's in IBU
sum(is.na(combined$ABV)) #number of NA's in ABV

combined_df <- combined
#Generalized Imputation on Mean for ABV
#calculated mean for all non-missing values & replaced NA's with mean.
combined_df$ABV <- ifelse(is.na(combined_df$ABV),
                       round(sample((mean(combined_df$ABV, na.rm=T) - sd(combined_df$ABV, na.rm=T)):
                                      (mean(combined_df$ABV, na.rm=T) + sd(combined_df$ABV, na.rm=T)),
                             size=sum(is.na(combined_df$ABV)), replace=T), 0), combined_df$ABV)

#Subset known IBU's for train/test
ibu_known <- combined_df[which(!is.na(combined_df$IBU)),]
ibu_unknown <- combined_df[which(is.na(combined_df$IBU)),]

#Training nB for classifying IBU
model <- naiveBayes(IBU~., data=ibu_known)

###multiple iterations
iterations = 150
masterAcc = matrix(nrow = iterations)

for(j in 1:iterations){
  train <- ibu_known[sample(seq(1:length(ibu_known$IBU)),
                                round(.7*length(ibu_known$IBU))),]
  test <- ibu_known[-sample(seq(1:length(ibu_known$IBU)),
                                round(.7*length(ibu_known$IBU))),]

  pred <- predict(model, train)
  t1 <- table(factor(pred, union(pred, train$IBU)),
              factor(train$IBU, union(pred, train$IBU)))
  CM <- confusionMatrix(t1)
  masterAcc[j] = CM$overall[1]
}
colMeans(masterAcc) #average accuracy across the 150 iterations
var(masterAcc) #measure of the variance across the 150 iterations

#Impute IBU's for unknowns (using nB model)
imp <- predict(model, ibu_unknown)
ibu_unknown_nB <- ibu_unknown

for(i in 1:nrow(ibu_unknown_nB)){
  ibu_unknown_nB$IBU[i] <- imp[i]
}
combined_df_nB <- rbind(ibu_known,ibu_unknown_nB)
combined_df_nB <- combined_df_nB[order(combined_df_nB$Brewery_id),]
```

#Question 4

##Compute the median alcohol content and international bitterness unit for each state. Plot a bar chart to compare.
```{r}
q4_df <- combined_df_nB %>% 
  group_by(State) %>% 
  mutate(ABV=median(ABV, na.rm=T), IBU=median(IBU, na.rm=T))

combined_df_nB %>% group_by(State) %>%
  ggplot(aes(x=State, y=IBU)) +
  geom_bar(stat="identity") +
  labs(title="Median IBU by State\ngrouped by Region") +
  facet_wrap(~Region, scale="free")
  

#scaling factor
sf <- max(q4_df$IBU, na.rm=T)/max(q4_df$ABV, na.rm=T)

q4_df %>% mutate(ABV=ABV*sf) %>%
  pivot_longer(names_to='y_new', values_to='val', ABV:IBU) %>%
  ggplot(aes(x=State)) +
  geom_bar(aes(y=val, fill=y_new, group=y_new),
           stat='identity', position=position_dodge()) +
  scale_y_continuous(name="IBU", labels=scales::comma,
                     sec.axis=sec_axis(~./sf, name="ABV",
                                       labels=scales::comma)) +
  facet_wrap(~Region, scale='free') +
  ggtitle("Median ABV & IBU by State") +
  theme(legend.position="bottom",
        #guide_legend(title=NULL),
        axis.text.x=element_text(angle=45,hjust=0.8)) +
  labs(fill=NULL)
```

#Question 5

##Which state has the maximum alcoholic (ABV) beer? Which state has the most bitter (IBU) beer?
```{r}
#finding the state with max ABV
q5_ABV <- combined_df_nB[which.max(combined_df_nB$ABV),10]
#finding the state with max IBU
q5_IBU <- combined_df_nB[which.max(combined_df_nB$IBU),10]
```
The state with the ABV is `r state.name[match(q5_ABV,10,state.abb)]` with a value of `r max(combined$ABV)`. And the state with the highest IBU is `r state.name[match(q5_IBU,10,state.abb)]` with an ABV of `r max(combined$IBU)`. Neither of these values came from the imputed data (i.e. they were not previously NA values).

#Question 6

##Comment on the summary statistics and distribution of the ABV variable.
```{r}
combined_df_nB %>% 
  summarise(minABV = min(ABV),
            q1ABV = quantile(x=ABV, probs=0.25),
            medianABV = median(ABV),
            q3ABV = quantile(x=ABV, probs=0.75),
            maxABV = max(ABV),
            meanABV = mean(ABV),
            sdABV = sd(ABV),
            )

zeros <- sum(ifelse(combined_df_nB==0,1,0))

combined_df_nB %>%
  ggplot(aes(x=ABV)) +
  geom_histogram(stat="count", color="black", fill="goldenrod")
```
The ABV variable had `r zeros` imputed 0's. The error rate for this is `r zeros/length(combined_df_nB$ABV)*100`%.


#Question 7

##Is there an apparent relationship between the bitterness of the beer and its alcoholic content? Draw a scatter plot. Make your best judgment of a relationship and EXPLAIN your answer.
```{r}
combined_df_nB %>%
  ggplot(aes(x=ABV, y=IBU)) +
  geom_point() +
  labs(title="ABV and IBU comparison")
```
The relationship between ABV and IBU does appear to be positive. However, two “barriers” to this trend appear at ABV’s of 0.00 (which were data-points imputed by the nB model) and 0.10.
